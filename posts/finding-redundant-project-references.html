<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Finding redundant project references | PEKâ€™s developer blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Finding redundant project references" />
<meta name="author" content="PEK" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When you are working with a nontrivial .NET solution you will eventually have a lot of references between projects and NuGet-packages. Here is a little script that finds references that are no longer needed in .NET Core projects." />
<meta property="og:description" content="When you are working with a nontrivial .NET solution you will eventually have a lot of references between projects and NuGet-packages. Here is a little script that finds references that are no longer needed in .NET Core projects." />
<link rel="canonical" href="https://pekspro.github.io/posts/finding-redundant-project-references" />
<meta property="og:url" content="https://pekspro.github.io/posts/finding-redundant-project-references" />
<meta property="og:site_name" content="PEKâ€™s developer blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-31T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Finding redundant project references" />
<script type="application/ld+json">
{"description":"When you are working with a nontrivial .NET solution you will eventually have a lot of references between projects and NuGet-packages. Here is a little script that finds references that are no longer needed in .NET Core projects.","headline":"Finding redundant project references","dateModified":"2021-01-31T00:00:00+01:00","datePublished":"2021-01-31T00:00:00+01:00","url":"https://pekspro.github.io/posts/finding-redundant-project-references","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://pekspro.github.io/posts/finding-redundant-project-references"},"author":{"@type":"Person","name":"PEK"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://pekspro.github.io/feed.xml" title="PEK's developer blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">PEK&#39;s developer blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a><a class="page-link" href="/categories">Categories</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Finding redundant project references</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-01-31T00:00:00+01:00" itemprop="datePublished">
        Jan 31, 2021
      </time>
        â€¢  Categories: 
        <a href="/categories#net">.NET</a>,
            <a href="/categories#powershell">PowerShell</a>
      </p>
  </header>
  <div class="post-content e-content" itemprop="articleBody">
    <p>When you are working with a nontrivial .NET solution you will eventually have a
lot of references between projects and NuGet-packages. Here is a little script
that finds references that are no longer needed in .NET Core projects.</p>

<h2 id="the-problem">The problem</h2>

<p>Having references to projects or NuGet packages that is no longer needed will
make you project slower to build, and it might also be a bit slower to run. So,
removing redundant references is a good thing. But how do you find these
references?</p>

<h2 id="the-solution">The solution</h2>

<p>My solution is to try to remove one reference at the time and then rebuild the
project. If it still works, it could probably be removed. Doing this manually is
very tedious, but with some PowerShell code it will not require much work.</p>

<p>The script below is doing just this, removing one reference as checks if the
project still compiles. When it has checked every reference, you will get a
summary.</p>

<p>Since it is modifying the project files (it will restore the file is nothing
unexpected happen) you should have a backup. Also, be aware that this will take
a while to run. Do not be surprised it takes more than one hour on a large
project.</p>

<p>Do not be surprised if you can not remove every reference that is suggested. Due
dependencies you may be able to remove one suggested reference but not two. The
script gives you suggestions about references that may be able to be removed. In
the end it is up to you to decide what to do with this.</p>

<p>Before you run the script, you need to change the path to directory that
contains all projects that should be checked.</p>

<div class="codeHeader" data-bi-name="code-header">
    <span class="language"> PowerShell </span>
    <button type="button" class="action is-relative copy-code-button" aria-label="Copy code">
        <span style="font-size: .800em; margin-right: .25em; position: relative; top: -.25em; left: -.200em; pointer-events: none;">
            ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span>
        </span>
        <span style="pointer-events: none;">Copy</span>
        <div class="successful-copy-alert is-transparent" style="pointer-events: none;" aria-hidden="true">
            &#10003;
        </div>
    </button> 
</div>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">Get-PackageReferences</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="nv">$FileName</span><span class="p">,</span><span class="w"> </span><span class="nv">$IncludeReferences</span><span class="p">,</span><span class="w"> </span><span class="nv">$IncludeChildReferences</span><span class="p">)</span><span class="w">

    </span><span class="nv">$xml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">xml</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Content</span><span class="w"> </span><span class="nv">$FileName</span><span class="p">)</span><span class="w">

    </span><span class="nv">$references</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">

    </span><span class="kr">if</span><span class="p">(</span><span class="nv">$IncludeReferences</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$packageReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Xml</span><span class="w"> </span><span class="nt">-XPath</span><span class="w"> </span><span class="s2">"Project/ItemGroup/PackageReference"</span><span class="w">

        </span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$node</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$packageReferences</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="p">)</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Version</span><span class="p">)</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nv">$references</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
                        </span><span class="nx">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">(</span><span class="nx">Split</span><span class="err">-</span><span class="nx">Path</span><span class="w"> </span><span class="nv">$FileName</span><span class="w"> </span><span class="err">-</span><span class="nx">Leaf</span><span class="err">)</span><span class="p">;</span><span class="w">
                        </span><span class="nx">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="err">.</span><span class="nx">Node</span><span class="err">.</span><span class="nx">Include</span><span class="p">;</span><span class="w">
                        </span><span class="nx">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="err">.</span><span class="nx">Node</span><span class="err">.</span><span class="nx">Version</span><span class="p">;</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">if</span><span class="p">(</span><span class="nv">$IncludeChildReferences</span><span class="p">)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nv">$projectReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Xml</span><span class="w"> </span><span class="nt">-XPath</span><span class="w"> </span><span class="s2">"Project/ItemGroup/ProjectReference"</span><span class="w">

        </span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$node</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$projectReferences</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="p">)</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nv">$childPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="n">Split-Path</span><span class="w"> </span><span class="nv">$FileName</span><span class="w"> </span><span class="nt">-Parent</span><span class="p">)</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="w">

                </span><span class="nv">$childPackageReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-PackageReferences</span><span class="w"> </span><span class="nv">$childPath</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="bp">$true</span><span class="w">

                </span><span class="nv">$references</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$childPackageReferences</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">   
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$references</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">Get-ProjectReferences</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="nv">$FileName</span><span class="p">,</span><span class="w"> </span><span class="nv">$IncludeReferences</span><span class="p">,</span><span class="w"> </span><span class="nv">$IncludeChildReferences</span><span class="p">)</span><span class="w">

    </span><span class="nv">$xml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">xml</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Content</span><span class="w"> </span><span class="nv">$FileName</span><span class="p">)</span><span class="w">

    </span><span class="nv">$references</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">

    </span><span class="kr">if</span><span class="p">(</span><span class="nv">$IncludeReferences</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$projectReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Xml</span><span class="w"> </span><span class="nt">-XPath</span><span class="w"> </span><span class="s2">"Project/ItemGroup/ProjectReference"</span><span class="w">

        </span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$node</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$projectReferences</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="p">)</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nv">$references</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
                    </span><span class="nx">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">(</span><span class="nx">Split</span><span class="err">-</span><span class="nx">Path</span><span class="w"> </span><span class="nv">$FileName</span><span class="w"> </span><span class="err">-</span><span class="nx">Leaf</span><span class="err">)</span><span class="p">;</span><span class="w">
                    </span><span class="nx">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="err">.</span><span class="nx">Node</span><span class="err">.</span><span class="nx">Include</span><span class="p">;</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">if</span><span class="p">(</span><span class="nv">$IncludeChildReferences</span><span class="p">)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nv">$projectReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Xml</span><span class="w"> </span><span class="nt">-XPath</span><span class="w"> </span><span class="s2">"Project/ItemGroup/ProjectReference"</span><span class="w">

        </span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$node</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$projectReferences</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="p">)</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nv">$childPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="p">(</span><span class="n">Split-Path</span><span class="w"> </span><span class="nv">$FileName</span><span class="w"> </span><span class="nt">-Parent</span><span class="p">)</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="w">

                </span><span class="nv">$childProjectReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ProjectReferences</span><span class="w"> </span><span class="nv">$childPath</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="bp">$true</span><span class="w">

                </span><span class="nv">$references</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$childProjectReferences</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">   
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$references</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\MySolutionDirectory</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*.</span><span class="nf">csproj</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w">

</span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Number of projects: </span><span class="si">$(</span><span class="nv">$files</span><span class="o">.</span><span class="nf">Length</span><span class="si">)</span><span class="s2">"</span><span class="w">

</span><span class="nv">$stopWatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Diagnostics.Stopwatch</span><span class="p">]::</span><span class="n">startNew</span><span class="p">()</span><span class="w">

</span><span class="nv">$obseletes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">

</span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$file</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

    </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">""</span><span class="w">
    </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Testing project: </span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">"</span><span class="w">

    </span><span class="nv">$rawFileContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w">

    </span><span class="nv">$childPackageReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-PackageReferences</span><span class="w"> </span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="w"> </span><span class="bp">$false</span><span class="w"> </span><span class="bp">$true</span><span class="w">
    </span><span class="nv">$childProjectReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ProjectReferences</span><span class="w"> </span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="w"> </span><span class="bp">$false</span><span class="w"> </span><span class="bp">$true</span><span class="w">

    </span><span class="nv">$xml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">xml</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Content</span><span class="w"> </span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w">

    </span><span class="nv">$packageReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Xml</span><span class="w"> </span><span class="nt">-XPath</span><span class="w"> </span><span class="s2">"Project/ItemGroup/PackageReference"</span><span class="w">
    </span><span class="nv">$projectReferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Xml</span><span class="w"> </span><span class="nt">-XPath</span><span class="w"> </span><span class="s2">"Project/ItemGroup/ProjectReference"</span><span class="w">

    </span><span class="nv">$nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="nv">$packageReferences</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">@(</span><span class="nv">$projectReferences</span><span class="p">)</span><span class="w">

    </span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$node</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$nodes</span><span class="p">)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nv">$previousNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">PreviousSibling</span><span class="w">
        </span><span class="nv">$parentNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">ParentNode</span><span class="w">
        </span><span class="nv">$parentNode</span><span class="o">.</span><span class="nf">RemoveChild</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="bp">$null</span><span class="w">

        </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nv">$xml</span><span class="o">.</span><span class="nf">Save</span><span class="p">(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w">

            </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Version</span><span class="p">)</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nv">$existingChildInclude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$childPackageReferences</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Version</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Version</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-First</span><span class="w"> </span><span class="nx">1</span><span class="w">

                </span><span class="kr">if</span><span class="p">(</span><span class="nv">$existingChildInclude</span><span class="p">)</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2"> references package </span><span class="si">$(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="si">)</span><span class="s2"> (</span><span class="si">$(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Version</span><span class="si">)</span><span class="s2">) that is also referenced in child project </span><span class="si">$(</span><span class="nv">$existingChildInclude</span><span class="o">.</span><span class="nf">File</span><span class="si">)</span><span class="s2">."</span><span class="w">
                    </span><span class="kr">continue</span><span class="w">
                </span><span class="p">}</span><span class="w">
                </span><span class="kr">else</span><span class="w"> 
                </span><span class="p">{</span><span class="w">
                    </span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-NoNewline</span><span class="w"> </span><span class="s2">"Building </span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2"> without package </span><span class="si">$(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="si">)</span><span class="s2"> (</span><span class="si">$(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Version</span><span class="si">)</span><span class="s2">)... "</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="kr">else</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nv">$existingChildInclude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$childProjectReferences</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-First</span><span class="w"> </span><span class="nx">1</span><span class="w">

                </span><span class="kr">if</span><span class="p">(</span><span class="nv">$existingChildInclude</span><span class="p">)</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2"> references project </span><span class="si">$(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="si">)</span><span class="s2"> that is also referenced in child project </span><span class="si">$(</span><span class="nv">$existingChildInclude</span><span class="o">.</span><span class="nf">File</span><span class="si">)</span><span class="s2">."</span><span class="w">
                    </span><span class="kr">continue</span><span class="w">
                </span><span class="p">}</span><span class="w">
                </span><span class="kr">else</span><span class="w"> 
                </span><span class="p">{</span><span class="w">
                    </span><span class="n">Write-Host</span><span class="w"> </span><span class="nt">-NoNewline</span><span class="w"> </span><span class="s2">"Building </span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2"> without project </span><span class="si">$(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Include</span><span class="si">)</span><span class="s2">... "</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="kr">else</span><span class="w"> 
        </span><span class="p">{</span><span class="w">
            </span><span class="kr">continue</span><span class="w">
        </span><span class="p">}</span><span class="w">

        </span><span class="n">dotnet</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="bp">$null</span><span class="w">

        </span><span class="kr">if</span><span class="p">(</span><span class="bp">$LastExitCode</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Building succeeded."</span><span class="w">

            </span><span class="kr">if</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="o">.</span><span class="nf">Version</span><span class="p">)</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nv">$obseletes</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
                    </span><span class="nx">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$file</span><span class="p">;</span><span class="w">
                    </span><span class="nx">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Package'</span><span class="p">;</span><span class="w">
                    </span><span class="nx">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="err">.</span><span class="nx">Node</span><span class="err">.</span><span class="nx">Include</span><span class="p">;</span><span class="w">
                    </span><span class="nx">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="err">.</span><span class="nx">Node</span><span class="err">.</span><span class="nx">Version</span><span class="p">;</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="kr">else</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nv">$obseletes</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
                    </span><span class="nx">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$file</span><span class="p">;</span><span class="w">
                    </span><span class="nx">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Project'</span><span class="p">;</span><span class="w">
                    </span><span class="nx">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$node</span><span class="err">.</span><span class="nx">Node</span><span class="err">.</span><span class="nx">Include</span><span class="p">;</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="kr">else</span><span class="w"> 
        </span><span class="p">{</span><span class="w">
            </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Building failed."</span><span class="w">
        </span><span class="p">}</span><span class="w">


        </span><span class="kr">if</span><span class="p">(</span><span class="bp">$null</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$previousNode</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nv">$parentNode</span><span class="o">.</span><span class="nf">PrependChild</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="bp">$null</span><span class="w">
        </span><span class="p">}</span><span class="w"> 
        </span><span class="kr">else</span><span class="w"> 
        </span><span class="p">{</span><span class="w">
            </span><span class="nv">$parentNode</span><span class="o">.</span><span class="nf">InsertAfter</span><span class="p">(</span><span class="nv">$node</span><span class="o">.</span><span class="nf">Node</span><span class="p">,</span><span class="w"> </span><span class="nv">$previousNode</span><span class="o">.</span><span class="nf">Node</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="bp">$null</span><span class="w">
        </span><span class="p">}</span><span class="w">

        </span><span class="c"># $xml.OuterXml</span><span class="w">

        </span><span class="nv">$xml</span><span class="o">.</span><span class="nf">Save</span><span class="p">(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="p">,</span><span class="w"> </span><span class="nv">$rawFileContent</span><span class="p">)</span><span class="w">

    </span><span class="n">dotnet</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="bp">$null</span><span class="w">

    </span><span class="kr">if</span><span class="p">(</span><span class="bp">$LastExitCode</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Error</span><span class="w"> </span><span class="s2">"Failed to build </span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="si">)</span><span class="s2"> after project file restore. Was project broken before?"</span><span class="w">
        </span><span class="kr">return</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"-------------------------------------------------------------------------"</span><span class="w">
</span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Analyse completed in </span><span class="si">$(</span><span class="nv">$stopWatch</span><span class="o">.</span><span class="nf">Elapsed</span><span class="o">.</span><span class="nf">TotalSeconds</span><span class="si">)</span><span class="s2"> seconds"</span><span class="w">
</span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$obseletes</span><span class="o">.</span><span class="nf">Length</span><span class="si">)</span><span class="s2"> reference(s) could potentially be removed."</span><span class="w">

</span><span class="nv">$previousFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$null</span><span class="w">
</span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$obselete</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$obseletes</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="kr">if</span><span class="p">(</span><span class="nv">$previousFile</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="nv">$obselete</span><span class="o">.</span><span class="nf">File</span><span class="p">)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">""</span><span class="w">
        </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Project: </span><span class="si">$(</span><span class="nv">$obselete</span><span class="o">.</span><span class="nf">File</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">"</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">if</span><span class="p">(</span><span class="nv">$obselete</span><span class="o">.</span><span class="nf">Type</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Package'</span><span class="p">)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Package reference: </span><span class="si">$(</span><span class="nv">$obselete</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2"> (</span><span class="si">$(</span><span class="nv">$obselete</span><span class="o">.</span><span class="nf">Version</span><span class="si">)</span><span class="s2">)"</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">else</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Project refence: </span><span class="si">$(</span><span class="nv">$obselete</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">"</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="nv">$previousFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$obselete</span><span class="o">.</span><span class="nf">File</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h2 id="summary">Summary</h2>

<p>This was a fun script to do. It took me some hours to write this, but it was
worth it.</p>

  </div>
  
    <div id="archives" class="related"><div class="archive-group">
    
      
      <div id="#net"></div>
      <p></p>
  
      <h3 class="category-head">More about .NET</h3>
      
      <article class="archive-item">
        <h4><a href="/posts/get-time-zone-for-a-user-in-graph">Get time zone for a user in Graph</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/invite-to-a-meeting">Invite to a meeting</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/caching-configuration-from-azure-keyvault">Caching configuration from Azure KeyVault</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/creating-unique-excel-sheet-names">Creating unique Excel sheet names</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/finding-objects-that-are-not-disposed">Finding objects that are not disposed</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/policyscope">PolicyScope</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/manually-creating-a-dbcontext-and-enable-logging">Manually creating a DbContext and enable logging</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/graphemes">Graphemes</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/withpartitionkey-and-in-memory-database">WithPartitionKey and in-memory database</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/net5-and-azure-functions">.NET 5 and Azure Functions</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/how-to-use-JWT-token-from-query-string">How to use JWT token from query string</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/what-characters-are-whitespace">What characters are whitespace?</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/trimming-whitespace-in-objects">Trimming whitespace in objects</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/modifying-query-string">Modifying query strings</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/create-a-time-lapse-video">Create a time lapse video</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/change-language-version-on-multiple-projects">Change language version on multiple projects</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/change-encoding-on-your-source-files">Change encoding on your source files</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/build-time">Build time</a></h4>
      </article>
      
    </div>
    
  
  
  
    <div class="archive-group">
    
      
      <div id="#powershell"></div>
      <p></p>
  
      <h3 class="category-head">More about PowerShell</h3>
      
      <article class="archive-item">
        <h4><a href="/posts/net5-and-azure-functions">.NET 5 and Azure Functions</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/prettifying-json-with-powerwhell">Prettifying JSON with PowerShell</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/multiple-find-and-replace-with-powershell">Multiple find and replace with PowerShell</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/extracting-urls-from-files-with-powershell">Extracting URL:s from files with PowerShell</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/change-encoding-on-your-source-files">Change encoding on your source files</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/compiling-with-a-RAM-Drive">Compiling with a RAM-drive</a></h4>
      </article>
      
    </div>
    
  
  </div><a class="u-url" href="/posts/finding-redundant-project-references" hidden></a>
</article>

<script src="/assets/javascript/copybutton.js"></script>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">PEK</li>
          <li><a class="u-email" href="mailto:"></a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Interesting problems with interesting solutions.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/pekspro" title="pekspro"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
