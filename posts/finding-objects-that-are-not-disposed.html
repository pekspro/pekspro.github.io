<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Finding objects that are not disposed | PEKâ€™s developer blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Finding objects that are not disposed" />
<meta name="author" content="PEK" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Making sure objects are properly disposed could be tricky. Here are some ways I deal with this." />
<meta property="og:description" content="Making sure objects are properly disposed could be tricky. Here are some ways I deal with this." />
<link rel="canonical" href="https://pekspro.github.io/posts/finding-objects-that-are-not-disposed" />
<meta property="og:url" content="https://pekspro.github.io/posts/finding-objects-that-are-not-disposed" />
<meta property="og:site_name" content="PEKâ€™s developer blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-14T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Finding objects that are not disposed" />
<script type="application/ld+json">
{"description":"Making sure objects are properly disposed could be tricky. Here are some ways I deal with this.","headline":"Finding objects that are not disposed","dateModified":"2021-02-14T00:00:00+01:00","datePublished":"2021-02-14T00:00:00+01:00","url":"https://pekspro.github.io/posts/finding-objects-that-are-not-disposed","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://pekspro.github.io/posts/finding-objects-that-are-not-disposed"},"author":{"@type":"Person","name":"PEK"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://pekspro.github.io/feed.xml" title="PEK's developer blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">PEK&#39;s developer blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a><a class="page-link" href="/categories">Categories</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Finding objects that are not disposed</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-02-14T00:00:00+01:00" itemprop="datePublished">
        Feb 14, 2021
      </time>
        â€¢  Categories: 
        <a href="/categories#net">.NET</a>
      </p>
  </header>
  <div class="post-content e-content" itemprop="articleBody">
    <p>Making sure objects are properly disposed could be tricky. Here are some ways I
deal with this.</p>

<h2 id="the-problem">The problem</h2>

<p>When you are creating an object that implements
<a href="https://docs.microsoft.com/en-us/dotnet/api/system.idisposable?view=net-5.0"><code class="language-plaintext highlighter-rouge">IDisposable</code></a>,
you are supposed to dispose this object when you are done with it. This way the
object has a chance to close files, close network connections. If you do not do
this these resources will be in use for an unknown amount of time and this could
cause unexpected errors.</p>

<p>Normally you do this with the <code class="language-plaintext highlighter-rouge">using</code> keyword:</p>

<div class="codeHeader" data-bi-name="code-header">
    <span class="language"> Using sample </span>
    <button type="button" class="action is-relative copy-code-button" aria-label="Copy code">
        <span style="font-size: .800em; margin-right: .25em; position: relative; top: -.25em; left: -.200em; pointer-events: none;">
            ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span>
        </span>
        <span style="pointer-events: none;">Copy</span>
        <div class="successful-copy-alert is-transparent" style="pointer-events: none;" aria-hidden="true">
            &#10003;
        </div>
    </button> 
</div>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">myMemoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// more code</span>
<span class="p">}</span></code></pre></figure>

<p>Doing like this <code class="language-plaintext highlighter-rouge">myMemoryStream</code> will be disposed when it is no longer in use.
In principle this is easy. But it is easy to simply forget about this. And there are more complicated scenarios were this is not possible.</p>

<h2 id="the-solution">The solution</h2>

<p>One solution I have been using for a long time only works for classes you
implement yourself and are using <code class="language-plaintext highlighter-rouge">IDisposable</code>. But it is neat anyway.</p>

<p>Look on this sample code:</p>

<div class="codeHeader" data-bi-name="code-header">
    <span class="language"> Using sample </span>
    <button type="button" class="action is-relative copy-code-button" aria-label="Copy code">
        <span style="font-size: .800em; margin-right: .25em; position: relative; top: -.25em; left: -.200em; pointer-events: none;">
            ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span>
        </span>
        <span style="pointer-events: none;">Copy</span>
        <div class="successful-copy-alert is-transparent" style="pointer-events: none;" aria-hidden="true">
            &#10003;
        </div>
    </button> 
</div>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">MissingDisposeCatcher</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">MyDisposable</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="n">disposedValue</span><span class="p">;</span>

        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">disposedValue</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">disposing</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// TODO: dispose managed state (managed objects)</span>
                <span class="p">}</span>

                <span class="c1">// TODO: free unmanaged resources (unmanaged objects) and override finalizer</span>
                <span class="c1">// TODO: set large fields to null</span>
                <span class="n">disposedValue</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="p">~</span><span class="nf">MyDisposable</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// This object was not disposed properly! Break execution in debugger.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debugger</span><span class="p">.</span><span class="n">IsAttached</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debugger</span><span class="p">.</span><span class="nf">Break</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="c1">// Do not change this code. Put cleanup code in 'Dispose(bool disposing)' method</span>
            <span class="nf">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">:</span> <span class="k">false</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// Do not change this code. Put cleanup code in 'Dispose(bool disposing)' method</span>
            <span class="nf">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">SuppressFinalize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyDisposable</span><span class="p">();</span>

                <span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span>

                <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Here <code class="language-plaintext highlighter-rouge">MyDisposable</code> implements the <a href="https://docs.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose">normal dispose
pattern</a>.
But I have done a minor tweak, I have added this destructor code:</p>

<div class="codeHeader" data-bi-name="code-header">
    <span class="language"> Using sample </span>
    <button type="button" class="action is-relative copy-code-button" aria-label="Copy code">
        <span style="font-size: .800em; margin-right: .25em; position: relative; top: -.25em; left: -.200em; pointer-events: none;">
            ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span>
        </span>
        <span style="pointer-events: none;">Copy</span>
        <div class="successful-copy-alert is-transparent" style="pointer-events: none;" aria-hidden="true">
            &#10003;
        </div>
    </button> 
</div>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">~</span><span class="nf">MyDisposable</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// This object was not disposed properly! Break execution in debugger.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debugger</span><span class="p">.</span><span class="n">IsAttached</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debugger</span><span class="p">.</span><span class="nf">Break</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Do not change this code. Put cleanup code in 'Dispose(bool disposing)' method</span>
    <span class="nf">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">:</span> <span class="k">false</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>This is the
<a href="https://docs.microsoft.com/en-us/dotnet/api/system.object.finalize?view=net-5.0">destructor/finalizer</a>
of <code class="language-plaintext highlighter-rouge">MyDisposable</code>.  When the object is properly disposed,
<code class="language-plaintext highlighter-rouge">GC.SuppressFinalize(this)</code> is called and this will make sure that the finalizer
is never executed. If the object is not disposed, then the destructor is
executed. This will first check if the debugger is attached, and if it is it
will call
<a href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.debugger.break"><code class="language-plaintext highlighter-rouge">System.Diagnostics.Debugger.Break();</code></a>
which will behave exactly like a breakpoint. Then debugger will stop and now you
know something has went wrong.</p>

<h3 id="detecting-the-issue-during-compiling">Detecting the issue during compiling</h3>

<p>Another solution I have started to use recently is to use the code quality
analyzers that are <a href="https://docs.microsoft.com/en-us/visualstudio/code-quality/roslyn-analyzers-overview?view=vs-2019">enabled by default in .NET
5</a>.
But the specific analyzer <a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca2000">CA2000: Dispose objects before losing
scope</a>
is disabled by default. To change it, do this:</p>

<ul>
  <li>Go a project in Visual Studio.</li>
  <li>Select <strong>Dependencies</strong>.</li>
  <li>Select <strong>Analyzers</strong>.</li>
  <li>Select <strong>Microsoft.CodeAnalysis.NetAnalyzers</strong>.</li>
  <li>Right click on the rule <strong>CA2000</strong> and then set the <strong>Severity</strong> to
<strong>Warning</strong>.</li>
  <li>The setting is now saved in <strong>.editorconfig</strong>.
    <ul>
      <li>If you do not have an <strong>.editorconfig</strong> before, this file is now created on
the project level. You are then being suggested to move it to the solution
level, which is probably a good choice.</li>
    </ul>
  </li>
</ul>

<p>An
<a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/configuration-files#editorconfig">editorconfig</a>
file with this rule enabled looks like this:</p>

<div class="codeHeader" data-bi-name="code-header">
    <span class="language"> .editorconfig </span>
    <button type="button" class="action is-relative copy-code-button" aria-label="Copy code">
        <span style="font-size: .800em; margin-right: .25em; position: relative; top: -.25em; left: -.200em; pointer-events: none;">
            ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span>
        </span>
        <span style="pointer-events: none;">Copy</span>
        <div class="successful-copy-alert is-transparent" style="pointer-events: none;" aria-hidden="true">
            &#10003;
        </div>
    </button> 
</div>

<figure class="highlight"><pre><code class="language-config" data-lang="config">[*.<span class="n">cs</span>]

<span class="c"># CA2000: Dispose objects before losing scope
</span><span class="n">dotnet_diagnostic</span>.<span class="n">CA2000</span>.<span class="n">severity</span> = <span class="n">warning</span></code></pre></figure>

<p>It is worth mention that CA2000 only covers one scenario, in my experience the most common one. There are more analyzers that covers more scenarios with dispose:</p>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca1001">CA1001: Types that own disposable fields should be disposable</a></li>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca1063">CA1063: Implement IDisposable correctly</a></li>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca1816">CA1816: Call GC.SuppressFinalize correctly</a></li>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca2000">CA2000: Dispose objects before losing scope</a></li>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca2213">CA2213: Disposable fields should be disposed</a></li>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca2215">CA2215: Dispose methods should call base class dispose</a></li>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/quality-rules/ca2216">CA2216: Disposable types should declare finalizer</a></li>
</ul>

<p>Be aware that analyzers will make it slower to compile your code. It is a not a
major issue but something to be aware about. Also notice that the analyzers do
not work on .NET Standard libraries, at least not by default.</p>

<h2 id="summary">Summary</h2>

<p>Disposing objects properly are important so I use both solutions mentioned
above.</p>

  </div>
  
    <div id="archives" class="related"><div class="archive-group">
    
      
      <div id="#net"></div>
      <p></p>
  
      <h3 class="category-head">More about .NET</h3>
      
      <article class="archive-item">
        <h4><a href="/posts/get-time-zone-for-a-user-in-graph">Get time zone for a user in Graph</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/invite-to-a-meeting">Invite to a meeting</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/caching-configuration-from-azure-keyvault">Caching configuration from Azure KeyVault</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/creating-unique-excel-sheet-names">Creating unique Excel sheet names</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/finding-redundant-project-references">Finding redundant project references</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/policyscope">PolicyScope</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/manually-creating-a-dbcontext-and-enable-logging">Manually creating a DbContext and enable logging</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/graphemes">Graphemes</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/withpartitionkey-and-in-memory-database">WithPartitionKey and in-memory database</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/net5-and-azure-functions">.NET 5 and Azure Functions</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/how-to-use-JWT-token-from-query-string">How to use JWT token from query string</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/what-characters-are-whitespace">What characters are whitespace?</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/trimming-whitespace-in-objects">Trimming whitespace in objects</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/modifying-query-string">Modifying query strings</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/create-a-time-lapse-video">Create a time lapse video</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/change-language-version-on-multiple-projects">Change language version on multiple projects</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/change-encoding-on-your-source-files">Change encoding on your source files</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/build-time">Build time</a></h4>
      </article>
      
    </div>
    
  
  </div><a class="u-url" href="/posts/finding-objects-that-are-not-disposed" hidden></a>
</article>

<script src="/assets/javascript/copybutton.js"></script>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">PEK</li>
          <li><a class="u-email" href="mailto:"></a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Interesting problems with interesting solutions.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/pekspro" title="pekspro"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
