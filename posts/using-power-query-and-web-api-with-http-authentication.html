<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Power Query and Web API with HTTP authentication | PEK‚Äôs developer blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Power Query and Web API with HTTP authentication" />
<meta name="author" content="PEK" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="With Power Query you could easily get data from different data sources, like Excel-files, CSV-files, and Web API. But if you need to connect to a Web API that requires authentication things are not that easy." />
<meta property="og:description" content="With Power Query you could easily get data from different data sources, like Excel-files, CSV-files, and Web API. But if you need to connect to a Web API that requires authentication things are not that easy." />
<link rel="canonical" href="https://pekspro.github.io/posts/using-power-query-and-web-api-with-http-authentication" />
<meta property="og:url" content="https://pekspro.github.io/posts/using-power-query-and-web-api-with-http-authentication" />
<meta property="og:site_name" content="PEK‚Äôs developer blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-29T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Power Query and Web API with HTTP authentication" />
<script type="application/ld+json">
{"description":"With Power Query you could easily get data from different data sources, like Excel-files, CSV-files, and Web API. But if you need to connect to a Web API that requires authentication things are not that easy.","headline":"Power Query and Web API with HTTP authentication","dateModified":"2020-11-29T00:00:00+01:00","datePublished":"2020-11-29T00:00:00+01:00","url":"https://pekspro.github.io/posts/using-power-query-and-web-api-with-http-authentication","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://pekspro.github.io/posts/using-power-query-and-web-api-with-http-authentication"},"author":{"@type":"Person","name":"PEK"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://pekspro.github.io/feed.xml" title="PEK's developer blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">PEK&#39;s developer blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a><a class="page-link" href="/categories">Categories</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Power Query and Web API with HTTP authentication</h1>
    <p class="post-meta"><time class="dt-published" datetime="2020-11-29T00:00:00+01:00" itemprop="datePublished">
        Nov 29, 2020
      </time>
        ‚Ä¢  Categories: 
        <a href="/categories#excel">Excel</a>
      </p>
  </header>
  <div class="post-content e-content" itemprop="articleBody">
    <p>With Power Query you could easily get data from different data sources, like
Excel-files, CSV-files, and Web API. But if you need to connect to a Web API
that requires authentication things are not that easy.</p>

<h2 id="the-problem">The problem</h2>

<p>Let say you want to get data from this URL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://rsptournament/api/players
</code></pre></div></div>

<p>With this JWT token:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Bearer abc123
</code></pre></div></div>

<p>You start by going into Excel, select <strong>Data</strong> &gt; <strong>From web</strong>.</p>

<p><img src="/assets/images/0035/problem-1.png" alt="Select From Web" title="Select From Web" /></p>

<p>Next you enter the URL:</p>

<p><img src="/assets/images/0035/problem-2-enter-url.png" alt="Enter URL" title="Enter URL" /></p>

<p>Now you are being asked for authentication settings. If you select <strong>Web API</strong>
and enter the token as the <strong>Key</strong> this should just work, right? But when you
press <strong>Connect</strong> you get a very confusing error message saying: <strong>A web API key
can only be specified when a web API key name is provided</strong>.</p>

<p><img src="/assets/images/0035/problem-3.png" alt="Error message" title="Error message" /></p>

<p>The first time I run into this I got several question in my head:</p>

<ul>
  <li>What does this mean?</li>
  <li>How do I enter a key name?</li>
  <li>Will entering a key name make it work?</li>
  <li>Or how should I do this instead?</li>
  <li>How could this be so badly designed?</li>
</ul>

<h2 id="the-explanation">The explanation</h2>

<p>First, just a quick explanation why you get this error message. When you are
using <strong>Web API</strong> as authentication Power Query will try to authenticate by
sending the authentication key in the <strong>query string</strong>, <strong>not</strong> the
<strong>HTTP-header</strong>. In the case above, it will try to get data from this URL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://rsptournament/api/players?[ApiKeyName]=abc123
</code></pre></div></div>

<p>The UI is telling you that you need to provide the name that should be used in
the query string. The funny thing is that you cannot enter this in any UI. To do
this, you need to create the query from scratch in the advanced editor. It could
for instance look like this:</p>

<div class="codeHeader" data-bi-name="code-header">
    <span class="language"> Advanced editor </span>
    <button type="button" class="action is-relative copy-code-button" aria-label="Copy code">
        <span style="font-size: .800em; margin-right: .25em; position: relative; top: -.25em; left: -.200em; pointer-events: none;">
            üìÑ<span style="position: absolute; top: .25em; left: .25em">üìÑ</span>
        </span>
        <span style="pointer-events: none;">Copy</span>
        <div class="successful-copy-alert is-transparent" style="pointer-events: none;" aria-hidden="true">
            &#10003;
        </div>
    </button> 
</div>

<figure class="highlight"><pre><code class="language-text" data-lang="text">let
    Source = Json.Document(Web.Contents("https://rsptournament/api/players", [ApiKeyName="access_token"]))
in
    Source</code></pre></figure>

<p>After you have entered the Web API key in the UI, this URL will be used for
fetching the data:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://rsptournament/api/players?Token=abc123
</code></pre></div></div>

<p>Note that <strong>Token</strong> is now used as the name for the key. This is described in
the <a href="https://docs.microsoft.com/en-us/powerquery-m/web-contents">documentation</a>.</p>

<p>This was the explanation what the Web API setting is doing. But this does not
help us, we want to send the authorization in the HTTP header, not the query
string. How do we do that?</p>

<h2 id="the-solution">The solution</h2>

<p>After you have selected <strong>Data</strong> &gt; <strong>From web</strong> you should now select the
<strong>Advanced mode</strong>. You enter the URL and then in the bottom of the window you
enter the HTTP header manually. In the sample below I have selected that the
HTTP header <strong>Authorization</strong> should be used with the value <strong>Bearer abc123</strong>.</p>

<p><img src="/assets/images/0035/solution-2.png" alt="Enter URL and HTTP header authorization" title="Enter URL and HTTP header authorization" /></p>

<p>Next, when you are being asked for authentication you should select
<strong>Anonymous</strong>:</p>

<p><img src="/assets/images/0035/solution-3.png" alt="Select anonymous" title="Select anonymous" /></p>

<p>Since you already manually have provided the authentication this is the option
you should use. Select <strong>Connect</strong> and then you will see the data in the Power
Query editor as expected.</p>

<h2 id="summary">Summary</h2>

<p>There is a huge downside with this solution, the credentials will be stored
inside your Excel file. This is bad when it comes to security, I think. If you
instead should have used the built-in ‚Äúreal‚Äù Web API solution, every user that
wanted to access the API would be forced to enter the key. Then these
credentials are stored on the device, not in the individual files. If you
accidently enter some credentials that you no longer want, you could edit this
in <strong>Data</strong> &gt; <strong>Get Data</strong> &gt; <strong>Data source settings</strong>.</p>

<p><img src="/assets/images/0035/summary-data-source-settings.png" alt="Data source settings" title="Data source settings" /></p>

<p>Is fair as I know this is unfortunately not possible when doing authentication
via the HTTP header. And I have spent way much more time researching this than I
wanted.</p>

  </div>
  
    <div id="archives" class="related"><div class="archive-group">
    
      
      <div id="#excel"></div>
      <p></p>
  
      <h3 class="category-head">More about Excel</h3>
      
      <article class="archive-item">
        <h4><a href="/posts/be-careful-with-references-in-power-query">Be careful with references in Power Query</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/creating-unique-excel-sheet-names">Creating unique Excel sheet names</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/calling-an-api-multiple-times-with-power-query">Calling an API multiple times with Power Query</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/creating-accruals-with-power-query">Creating accruals with Power Query</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/how-to-use-JWT-token-from-query-string">How to use JWT token from query string</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/power-query-and-json-arrays">Power Query and JSON arrays</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/format-tables-in-excel-with-macros">Format tables in Excel with macros</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/creating-excel-files-in-azure-functions">Creating Excel-files in Azure Functions</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/creating-excel-files-in-logic-apps">Creating Excel-files in Logic Apps</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/power-query-grouping-and-filtering-data">Power Query - Grouping and filtering data</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/power-query-joining-data">Power Query - Joining data</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/power-query-working-with-columns">Power Query - Working with columns</a></h4>
      </article>
      
      <article class="archive-item">
        <h4><a href="/posts/power-query-get-started-in-excel">Power Query - Get started in Excel</a></h4>
      </article>
      
    </div>
    
  
  </div><a class="u-url" href="/posts/using-power-query-and-web-api-with-http-authentication" hidden></a>
</article>

<script src="/assets/javascript/copybutton.js"></script>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">PEK</li>
          <li><a class="u-email" href="mailto:"></a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Interesting problems with interesting solutions.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/pekspro" title="pekspro"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
